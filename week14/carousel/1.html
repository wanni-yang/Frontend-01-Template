<html>

<head>
    <title>carousel component</title>
    <style>
        .carousel {
            width: 500px;
            height: 300px;
            white-space: nowrap;
            outline: 1px solid blue;
            overflow: hidden;
            /* 可以看到transform的过程 同时关掉overflow*/
            /* zoom: 0.5; */
            margin: auto;
        }

        .carousel>img {
            width: 100%;
            height: 100%;
            /* display: inline-block; */
            transition: transform ease 1s;

        }
    </style>
</head>

<body>
    <div id="container"></div>
    <script>
        class Carousel {
            constructor() {
                this.root = null;
                this.data = null;
            }
            render() {
                // 处理逻辑
                this.root = document.createElement('div');
                this.root.classList.add('carousel');

                for (let d of this.data) {
                    let element = document.createElement("img");
                    element.src = d
                    element.addEventListener('dragstart', event => event.preventDefault())
                    this.root.appendChild(element)
                }
                let position = 0;
                let nextPic = () => {
                    let nextPosition = (position + 1) % this.data.length;
                    let current = this.root.childNodes[position];
                    let next = this.root.childNodes[nextPosition];
                    // 开始动画
                    current.style.transition = "none"; //两个意思一样
                    next.style.transition = "ease 0s";

                    // 起始
                    current.style.transform = `translateX(${-100 * position}%) `
                    next.style.transform = `translateX(${100 -100 * nextPosition}%) `

                    setTimeout(function () {
                        // use css rule transition
                        current.style.transition = "";
                        next.style.transition = "";
                        // 往左移动100%
                        current.style.transform = `translateX(${-100 -100 * position}%) `
                        next.style.transform = `translateX(${-100 * nextPosition}%) `
                        // 时序问题
                        position = nextPosition;
                    }, 16)
                    // 16ms是一帧

                    setTimeout(nextPic, 3000);
                }
                // setTimeout(nextPic, 3000);
                this.root.addEventListener('mousedown', event => {
                    let startX = event.clientX,
                        startY = event.clientY;
                    
                    let lastPosition = (position - 1 + this.data.length) % this.data.length; // fix -1
                    let nextPosition = (position + 1) % this.data.length;
                    // console.log(lastPosition,position,nextPosition) 3 0 1
                    let current = this.root.childNodes[position];
                    let last = this.root.childNodes[lastPosition];
                    let next = this.root.childNodes[nextPosition];
                    // 关掉transition
                    current.style.transition = "none";
                    next.style.transition = "none";
                    last.style.transition = "none";
                    // 因为在第一次轮播后第三个坑位是没有图的，mousedown是为了让对应的图放到第三个坑位内，做好下一次动画的准备
                    current.style.transform = `translateX(${-500 * position}px) ` // 0
                    last.style.transform = `translateX(${-500 -500* lastPosition}px) `// -1
                    next.style.transform = `translateX(${500-500 * nextPosition}px) ` //1

                    let move = event => {

                        current.style.transform =
                            `translateX(${event.clientX -startX -500 * position}px) `;
                        last.style.transform =
                            `translateX(${event.clientX -startX -500 -500 * lastPosition}px) `;
                        next.style.transform =
                            `translateX(${event.clientX -startX +500 -500 * nextPosition}px) `

                        // console.log(event.clientX-startX, event.clientY-startY)
                    }
                    let up = event => {
                        // 拖到一半就算变了
                        let offset = 0;
                        if(event.clientX -startX > 250){
                            offset = 1;
                        }else if(event.clientX - startX < -250){
                            offset = -1;
                        }
                        // 打开动画 transition
                        current.style.transition = "";
                        next.style.transition = "";
                        last.style.transition = "";
                        // transform 跟鼠标位置没关系
                        current.style.transform =
                            `translateX(${offset*500 -500 * position}px) `;
                        last.style.transform =
                            `translateX(${offset*500 -500 -500 * lastPosition}px) `;
                        next.style.transform =
                            `translateX(${offset*500 +500 -500 * nextPosition}px) `

                        position  = (position - offset + this.data.length) % this.data.length;
                        document.removeEventListener('mousemove', move)
                        document.removeEventListener('mouseup', up)
                    }
                    document.addEventListener('mousemove', move)
                    document.addEventListener('mouseup', up)
                })
            }
        }
        // create
        let carousel = new Carousel();
        // update
        carousel.data = [
            "1.jpg",
            "2.jpg",
            "3.jpg",
            "4.jpg",
        ];
        // update
        carousel.render();
        // mount
        document.getElementById("container").appendChild(carousel.root)
    </script>
</body>

</html>